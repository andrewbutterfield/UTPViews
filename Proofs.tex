\section{Proofs}\label{sec:proofs}



\subsection{Proof of \textsf{HL-X-red}}
\RLEQNS{
  && \HL(X(E|a|R|A))
\EQ{\eref{HL-def}}
\\&& \exists ls,ls' @ X(E|a|R|A)
\EQ{\eref{X-def}}
\\&& \exists ls,ls' @
     ls(E) \land s' \in \sem a s \land ls' = (ls \setminus R) \cup A
\EQ{1pt-law, $ls'$, noting that $E$ is ground}
\\&& \exists ls @
     ls(E) \land s' \in \sem a s
\EQ{reduce $ls$ scope}
\\&& (\exists ls @ ls(E)) \land s' \in \sem a s
\EQ{witness: $ls=E$}
\\&& s' \in \sem a s
}


\subsection{Proof of \textsf{HL-X-sub-red}}

We start with a lemma \elabel{X-gnd-subst}:
\RLEQNS{
  && X(E|a|R|A)[G,I,O/g,in,out]
\EQ{\eref{X-def}}
\\&& (ls(E) \land s' \in \sem a s \land ls' = (ls \setminus R) \cup A)
     [G,I,O/g,in,out]
\EQ{substitution}
\\&& ls(E[G,I,O/g,in,out])
    \land s' \in \sem a s
\\ &\land& ls' = (ls \setminus R[G,I,O/g,in,out]) \cup A[G,I,O/g,in,out]
\EQ{\eref{X-def}}
\\&& X(E[G,I,O/g,in,out]|a|R[G,I,O/g,in,out]|A[G,I,O/g,in,out])
}

\RLEQNS{
  && \HL(X(E|a|R|A)[G,I,O/g,in,out])
\EQ{\eref{X-gnd-subst}}
\\&& \HL(X(E[G,I,O/g,in,out]|a|R[G,I,O/g,in,out]|A[G,I,O/g,in,out]))
\EQ{\eref{HL-X-red}, provided $E[G,I,O/g,in,out]$ is ground.}
\\&& s' \in \sem a s
}

\subsection{Proof of \textsf{HL-or-distr}}
\RLEQNS{
  && \HL(A \lor B)
\EQ{\eref{HL-def}}
\\&& \exists ls,ls' @ A \lor B
\EQ{$\exists$-$\lor$-distr}
\\&& (\exists ls,ls' @ A) \lor (\exists ls,ls' @ B)
\EQ{\eref{HL-def}}
\\&& \HL(A) \lor \HL{B}
}

\subsection{Proof of \textsf{HL-I-and-skip}}
\RLEQNS{
  && \HL(I \land \Skip)
\EQ{\eref{UTP-skip-def}}
\\&& \HL(I \land ls'=ls \land s'=s)
\EQ{\eref{HL-def}}
\\&& \exists ls,ls' @ I \land ls'=ls \land s'=s
\EQ{1-pt, $ls'=ls$}
\\&& \exists ls @ I[ls/ls'] \land s'=s
\EQ{$ls'$ not in $I$}
\\&& \exists ls @ I \land s'=s
\EQ{shrink scope of $ls$, expand $I$ shorthand (a bit)}
\\&& (\exists ls @ ls \textbf{ lsat } I) \land s'=s
\EQ{witness, $ls=\emptyset$}
\\&& s'=s
\EQ{\eref{ii-def}}
\\&& ii
}
We note that we can deduce the following lemma,
that generalises to the use of ground substitutions $\sigma$:
\RLEQNS{
  && \exists ls @ I\sigma
\EQ{expand $I$ shorthand (a bit)}
\\&& (\exists ls @ ls \textbf{ lsat } I\sigma)
\EQ{witness, $ls=\emptyset$, substitution irrelevant}
\\&& \true
}
It also works if we have a conjunction of invariants:
\RLEQNS{
  \exists ls @ (I \land J)\sigma &=& \true
}
The one witness satisfies all such invariants.


\subsection{Proof of \textsf{HL-I-and-X}}
\RLEQNS{
  && \HL(I \land X(E|a|R|A) \land S)
\EQ{\eref{X-def}}
\\&& \HL(I \land ls(E) \land a \land ls'=(ls\setminus R)\cup A \land S)
\EQ{\eref{HL-def}}
\\&& \exists ls,ls' @ I \land ls(E) \land a \land ls'=(ls\setminus R)\cup A \land S)
\EQ{1-pt, $ls'=(ls\setminus R)\cup A$, noting $E$, $S$ are ground}
\\&& \exists ls @ I \land ls(E) \land a \land S)
\EQ{shrink scope of $ls$}
\\&& (\exists ls @ I \land ls(E)) \land a \land S)
\EQ{witness $ls=E$, assuming that $E \textbf{ lsat } I$}
\\&& a \land S
}

\subsection{Proof of \textsf{HL-I-and-A}}

Law \ecite{HL-I-and-A} is an easy consequence of \ecite{HL-I-and-X},
with $R=E$, $A=N$ and $S=\true$.

\subsection{Proof of \textsf{HL-nf}}


\RLEQNS{
  && \HL\left (I \land \left( \Skip \lor \bigvee A(a_i) \right) \right)
\EQ{$\land$-$\lor$-distr}
\\&& \HL\left( I \land \Skip \lor \bigvee (I \land A(a_i)) \right)
\EQ{\eref{HL-or-distr}}
\\&& \HL(I \land \Skip) \lor \bigvee \HL(I \land A(a_i))
\EQ{\eref{HL-I-and-skip} and \eref{HL-I-and-A}}
\\&& ii \lor \bigvee a_i
}

\subsection{Proof of \textsf{HL-subs-indep}}

We want to prove $\HL(P\sigma_1)=\HL(P\sigma_2)$, where
\begin{itemize}
  \item $P$ is a predicate that can be put in normal form.
  \item $\sigma_i$ is a substitution of the form $[G_i,I_i,O_i/g,in,out]$.
  \item $G_i$, $I_i$ and $O_i$ are ground.
\end{itemize}
We note the following lemmas that hold given such substitutions
(easy proofs as exercise):
\RLEQNS{
   \Skip\sigma    &=& \Skip                & \elabel{gnd-sub-skip}
\\ A(E|a|N)\sigma &=& A(E\sigma|a|N\sigma) & \elabel{gnd-sub-A}
}

We do this proof by induction over the UTCP syntax.

\subsubsection{\textsf{HL-subs-indep}, Base Case}

Here $\sigma=[G,I,O/g,in,out]$.
\RLEQNS{
  && \HL(a\sigma)
\EQ{\eref{nf-atomic}}
\\&& \HL(([in|out] \land (\Skip \lor A(in|a|out)))\sigma)
\EQ{$\land$-$\lor$-distr}
\\&& \HL(([in|out] \land \Skip \lor [in|out] \land A(in|a|out)))\sigma)
\EQ{substitution, using $\eref{gnd-sub-skip}$ and  $\eref{gnd-sub-A}$}
\\&& \HL([in\sigma|out\sigma] \land \Skip
         \lor
         [in\sigma|out\sigma] \land A(in\sigma|a|out\sigma)))
\EQ{Apply $\sigma$}
\\&& \HL([I|O] \land \Skip
         \lor
         [I|O] \land A(I|a|O)))
\EQ{\eref{HL-or-distr}}
\\&& \HL([I|O] \land \Skip)
         \lor
         \HL([I|O] \land A(I|a|O)))
\EQ{\eref{HL-I-and-skip} and \eref{HL-I-and-A}}
\\&& ii \lor a
}
We have $\HL(a\sigma) = ii \lor a$ for arbitrary ground $\sigma$,
so our result is immediate.

\subsubsection{\textsf{HL-subs-indep}, Inductive Hypothesis}

For each inductive step case below we assume,
for \emph{arbitrary} $\sigma_1$, $\sigma_2$.
\RLEQNS{
   \HL(P\sigma_1) &=& \HL(P\sigma_2) & \elabel{HL-subs-indep-hyp-P}
\\ \HL(Q\sigma_1) &=& \HL(Q\sigma_2) & \elabel{HL-subs-indep-hyp-Q}
}
We also assume the following normal forms,
where we distribute the invariant in.
\RLEQNS{
   P &=& I \land \Skip \lor \bigvee_j (I \land  A(a_j))
   & \elabel{HL-subs-indep-nf-P}
\\ Q &=& J \land \Skip \lor \bigvee_k  (J \land  A(b_k))
   & \elabel{HL-subs-indep-nf-Q}
}
An important lemma is one that states that these ground substitutions
distribute through UTP sequential composition:
\RLEQNS{
  (P \seq Q)\sigma &=& P\sigma \seq Q\sigma & \elabel{gnd-subs-seq-distr}
}

\subsubsection{\textsf{HL-subs-indep}, Step: Sequence}

\RLEQNS{
  && \HL((P \cseq Q)\sigma)
\EQ{\eref{sem:seq}}
\\&& \HL(([in|\ell_g|out]\land \W(P[g_{:1},\ell_g/g,out] \lor Q[g_{:2},\ell_g/g,in]))\sigma)
\EQ{\eref{W-as-NDC}}
\\&& \HL(([in|\ell_g|out]
          \land
          (\Skip
           \lor
           \bigvee_i (P[g_{:1},\ell_g/g,out]
                      \lor
                      Q[g_{:2},\ell_g/g,in])^i))\sigma)
\EQ{substitution, noting \eref{gnd-subs-seq-distr}}
\\&& \HL([in|\ell_g|out]\sigma
          \land
          (\Skip\sigma
           \lor
           \bigvee_i (P[g_{:1},\ell_g/g,out]\sigma
                      \lor
                      Q[g_{:2},\ell_g/g,in]\sigma)^i))
\EQ{\eref{gnd-sub-skip}, $\land$-$\lor$-distr}
\\&& \HL( [in|\ell_g|out]\sigma \land \Skip
          \lor
          [in|\ell_g|out]\sigma \land
            \bigvee_i (P[g_{:1},\ell_g/g,out]\sigma
                      \lor
                      Q[g_{:2},\ell_g/g,in]\sigma)^i)
\EQ{\eref{HL-or-distr}}
\\&& \HL( [in|\ell_g|out]\sigma \land \Skip)
          \lor
     \HL([in|\ell_g|out]\sigma \land
            \bigvee_i (P[g_{:1},\ell_g/g,out]\sigma
                      \lor
                      Q[g_{:2},\ell_g/g,in]\sigma)^i)
\EQ{\eref{HL-I-and-skip}, substitution, subst. composition}
\\&& \say{$\sigma_1 = [g_{:1},\ell_g/g,out]\sigma$}
\\&& \say{$\sigma_2 = [g_{:2},\ell_g/g,in]\sigma$}
\\&& ii \lor
     \HL([I|\ell_G|O] \land
            \bigvee_i (P\sigma_1
                      \lor
                      Q\sigma_2)^i)
\EQ{normal forms}
\\&& ii \lor
     \HL([I|\ell_G|O] \land
            \bigvee_i ((I \land \Skip \lor \bigvee_j (I \land  A(a_j)))\sigma_1
                      \lor
                      (J \land \Skip \lor \bigvee_k (J \land  A(b_k)))\sigma_2)^i)
\EQ{substitution, \eref{gnd-sub-skip}}
\\&& ii \lor
     \HL([I|\ell_G|O]
\\ && {} \land
            \bigvee_i ( I\sigma_1 \land \Skip \lor \bigvee_j (I\sigma_1 \land  A(a_j)\sigma_1)
                        \lor
                        J\sigma_2 \land \Skip \lor \bigvee_k (J\sigma_2 \land  A(b_k)\sigma_2))^i)
\EQ{$\land$-$\lor$-distr}
\\&& ii \lor
     \HL(\bigvee_i (
         [I|\ell_G|O] \land I\sigma_1 \land \Skip
         \lor
         \bigvee_j ([I|\ell_G|O] \land I\sigma_1 \land  A(a_j)\sigma_1)
\\&& \qquad\qquad\, {}\lor [I|\ell_G|O] \land J\sigma_2 \land \Skip
           \lor \bigvee_k ([I|\ell_G|O] \land J\sigma_2 \land  A(b_k)\sigma_2)
           )^i)
\EQ{HL-or-distr}
\\&& ii \lor
    \bigvee_i (
          \HL([I|\ell_G|O] \land I\sigma_1 \land \Skip)
         \lor
         \bigvee_j  \HL([I|\ell_G|O] \land I\sigma_1 \land  A(a_j)\sigma_1)
\\&& \qquad\qquad\, {}\lor  \HL([I|\ell_G|O] \land J\sigma_2 \land \Skip)
           \lor \bigvee_k  \HL([I|\ell_G|O] \land J\sigma_2 \land  A(b_k)\sigma_2)
           )^i
\EQ{\eref{HL-I-and-skip},\eref{HL-I-and-A}, with invariant conjuncts}
\\&& ii \lor
    \bigvee_i (
          ii
         \lor
         \bigvee_j  a_j
\lor  ii
           \lor \bigvee_k  b_k
           )^i
\EQ{tidy-up (not strictly necessary, but nice)}
\\&& ii \lor (\bigvee_j  a_j \lor \bigvee_k  b_k)^i
}
We see that $\HL((P\cseq Q)\sigma)$ is independent of $\sigma$,
provided $P$ and $Q$ have normal forms.
So we don't need induction here.
It is needed to show that our definitions do have these normal forms, though.

\subsection{Lemma \textsf{gnd-subs-seq-distr}}

\RLEQNS{
  && (P\seq Q)\sigma
\EQ{\eref{UTP-seq-def}}
\\&& (\exists s_m,ls_m @
       P[s_m,ls_m/s',ls']
       \land
       Q[s_m,ls_m/s,ls])\sigma
\EQ{$\sigma$ does not mention $s_m$, $ls_m$}
\\&& \exists s_m,ls_m @
       P[s_m,ls_m/s',ls']\sigma
       \land
       Q[s_m,ls_m/s,ls]\sigma
\EQ{$\sigma$ is ground, does not mention $s,s',ls,ls'$}
\\&& \exists s_m,ls_m @
       (P\sigma)[s_m,ls_m/s',ls']
       \land
       (Q\sigma)[s_m,ls_m/s,ls]
\EQ{\eref{UTP-seq-def}}
\\&& (P\sigma) \seq (Q\sigma)
}
In particular, this means that $(P^i)\sigma = (P\sigma)^i$.
