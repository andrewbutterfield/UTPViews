\section{Commands}\label{sec:commands}



\subsection{Syntax}

\begin{eqnarray*}
   a &:& \mbox{Predicate, alphabet }s,s'
\\ c &:& \mbox{Predicate, alphabet }s
\end{eqnarray*}

\RLEQNS{
   P &::= & c \pgrd a     & \mbox{Atomic Action}
\\   &\mid& \cskip        & \mbox{No state change}
\\   &\mid& P \cseq P     & \mbox{Sequential Composition}
\\   &\mid& P \parallel P & \mbox{Parallel Composition}
\\   &\mid& P+P           & \mbox{Non-deterministic Choice}
\\   &\mid& P^*           & \mbox{Non-deterministic Iteration}
\\   &\mid& P \dcond c P  & \mbox{Conditional Choice}
\\   &\mid& c \ddo P      & \mbox{Conditional Iteration}
}

\subsection{Domains}
\begin{eqnarray*}
   s &\in& \mathcal S
\\ g &:& Gen
\\ \ell &:& Gen \fun Lbl
\\ G \in Gen &::=&  g \mid G_{:} \mid G_1 \mid G_2
\\ L \in Lbl &::=& \ell_G
\end{eqnarray*}

\subsection{Alphabet}

\begin{eqnarray*}
   s, s' &:& \mathcal S
\\ ls, ls' &:& \mathcal P (Lbl)
\\ g &:& Gen
\\ in, out &:& Lbl
\end{eqnarray*}
We assume a general notion of expressions ($e$)
and say that an expression $e$ is ``ground''
if it's free variables are limited to only $g$, $in$ and $out$.



\subsection{``Standard'' UTP Constructs}

\RLEQNS{
   P \cond C Q
   &\defs&
   C \land P \lor \lnot C \land Q
   & \elabel{UTP-cond-def}
\\ \Skip
   &\defs&
   s'= s \land ls'=ls
   & \elabel{UTP-skip-def}
\\ P \seq Q
   &\defs& \exists s_m,ls_m \bullet
\\ && \qquad P[s_m,ls_m/s',ls'] \land Q[s_m,ls_m/s,ls]
   & \elabel{UTP-seq-def}
\\ C * P
   &=&
   P ; C * P \cond C \Skip
   & \elabel{UTP-loop-unroll}
}
We also define a specialised form of sequential composition
to be used when neither component refers to $ls$ or $ls'$,
and its unit:
\RLEQNS{
   P \seq_s Q
   &\defs&
   \exists s_m \bullet P[s_m/s'] \land Q[s_m/s]
   & \elabel{UTP-s-seq-def}
\\ ii &\defs& s'=s & \elabel{ii-def}
}
We often omit the $s$ subscript when its use is clear from context.


\subsection{Shorthands}

\RLEQNS{
   ls(\ell) &\defs& \ell \in ls
\\ ls(L) &\defs& L \subseteq ls
\\ ls(\B\ell) &\defs& \ell \notin ls
\\ ls(\B L) &\defs& L \cap ls = \emptyset
}

\subsection{Semantic Concepts}

\subsubsection{Basic Action}

\RLEQNS{
   A(E|a|N)
   &\defs&
   ls(E) \land a \land ls'=(ls\setminus E) \cup N
   & \elabel{A-def}
}


\subsubsection{Wheels-within-Wheels}

\begin{eqnarray*}
   \W(P) &\defs& \true * (\Skip \lor P)
\\         &  =  & \bigvee_{i \in 0,\dots} \Skip \seq P^i
\end{eqnarray*}

\subsubsection{Label-Set Invariant}

We want to be able to specify that certain combinations
of labels should never appear simultaneously
in the global label set ($ls$).

\RLEQNS{
   i \in I_\tau &::=& \tau \mid \otimes(i,\ldots,i) \mid \cup (i,\ldots,i)
}

\RLEQNS{
   A(E|a|N) \textbf{ sat } I
   &\defs&
   E \textbf{ lsat } I \land N \textbf{ lsat } I
}

\RLEQNS{
   occ &:& \power \tau \fun I_\tau \fun I_\Bool
\\ occ_L~\ell &\defs& \ell \in L
\\ occ_L~\otimes(i_1,\ldots,i_n)
   &\defs&
   \otimes(occ_L~i_1,\ldots,occ_L~i_n)
\\ occ_L~\cup(i_1,\ldots,i_n)
   &\defs&
   \cup(occ_L~i_1,\ldots,occ_L~i_n)
}

\RLEQNS{
   occChk &:& I_\Bool \fun (\setof{ok,fail}\times \Bool)
\\ occChk(b) &\defs& (ok,b)
\\ occChk(\cup(i_1,\ldots,i_n))
   &\defs&
   (fail,\_),
   \textbf{ if }\exists j @ occChk(i_j) = (fail,\_)
\\ && (ok,b_1 \lor \dots \lor b_n),
   \textbf{ if }\forall j @ occChk(i_j) = (ok,b_j)
\\ occChk(\otimes(i_1,\ldots,i_n))
   &\defs&
   (fail,\_),
   \textbf{ if }\exists j @ occChk(i_j) = (fail,\_)
\\&& (fail,\_) \mbox{ if more than one $(ok,true)$}
\\&& (ok,false) \mbox{ if all are $(ok,false)$}
\\&& (ok,true) \mbox{ if  exactly one $(ok,true)$}
}

Shorthand: $\otimes \mapsto |$, $\cup \mapsto ,$
\RLEQNS{
  ~ [ a,b,c | d,e | f ]
   &=&
   \otimes(\cup(a,b,c),\cup(d,e),f)
\\ ~[ a | (b|c),(d|e) | f ]
  &=&
  \otimes(a,\cup(\otimes(b,c),\otimes(d,e)),f)
}

\subsubsection{Invariant Examples}

\RLEQNS{
   ~[in|out]
   &=&
   \setof{in} \cap \setof{out} = \emptyset
\\ &\land&
  \setof{in} \subseteq ls \implies \setof{out}\cap ls = \emptyset
\\ &\land&
  \setof{out} \subseteq ls \implies \setof{in}\cap ls = \emptyset
\\ ~[in|\ell|out]
   &=&
   \setof{in} \cap \setof{\ell} = \emptyset
\\ &\land&
   \setof{in} \cap \setof{out} = \emptyset
\\ &\land&
   \setof{\ell} \cap \setof{out} = \emptyset
\\ &\land&
  \setof{in} \subseteq ls \implies \setof{\ell,out}\cap ls = \emptyset
\\ &\land&
  \setof{\ell} \subseteq ls \implies \setof{in,out}\cap ls = \emptyset
\\ &\land&
  \setof{out} \subseteq ls \implies \setof{in,\ell}\cap ls = \emptyset
}

\RLEQNS{
   ~[ a | (b|c),(d|e) | f ]
   &=&
   \setof{a} \cap \setof{b,c,d,e,f} = \emptyset
\\ &\land&
   \setof{b,c,d,e} \cap \setof{a,f} = \emptyset
\\ &\land&
   \setof{f} \cap \setof{a,b,c,d} = \emptyset
\\ &\land&
  \setof{a} \subseteq ls \implies \setof{b,c,d,e,f}\cap ls = \emptyset
\\ &\land&
  \setof{b,c,d,e} \subseteq ls \implies \setof{a,f}\cap ls = \emptyset
\\ &\land&
  \setof{f} \subseteq ls \implies \setof{a,b,c,d,e}\cap ls = \emptyset
\\ &\land&
   \setof{b} \cap \setof{c} = \emptyset
\\ &\land&
   \setof{d} \cap \setof{e} = \emptyset
\\ &\land&
  \setof{b} \subseteq ls \implies \setof{c}\cap ls = \emptyset
\\ &\land&
  \setof{c} \subseteq ls \implies \setof{b}\cap ls = \emptyset
\\ &\land&
  \setof{d} \subseteq ls \implies \setof{e}\cap ls = \emptyset
\\ &\land&
  \setof{e} \subseteq ls \implies \setof{d}\cap ls = \emptyset
}
Here one of $b$ or $c$ may occur in $ls$ along with one of  $d$ or $e$.


\subsection{Program Semantics}

\subsubsection{Guarded Atomic Action}

\RLEQNS{
 c \pgrd a &\defs& \W(A(in|c \land a|out)) \land [in|out]
\\ &=& (\Skip \lor A(in|c \land a|out)) \land [in|out]
}

\subsubsection{Skip}

\RLEQNS{
   ii     &\defs& s'=s
\\ \cskip &\defs& \true ~\pgrd~ ii
\\  &=& (\Skip \lor A(in|ii|out)) \land [in|out]
}

\subsubsection{Sequential Composition}

\RLEQNS{
   P \cseq Q
   &\defs&
   \W(P[g_{:1},\ell_g/g,out] \lor Q[g_{:2},\ell_g/g,in])
   \land [in|\ell_g|out]
}

\subsubsection{Parallell Composition}

\RLEQNS{
   P \parallel Q
   &\defs&
   \W(\quad\phlor A(in|ii|\ell_{g1},\ell_{g2})
\\ && \qquad {}\lor
   P[g_{1::},\ell_{g1},\ell_{g1:}/g,in,out]
   \lor Q[g_{2::},\ell_{g2},\ell_{g2:}/g,in,out]
\\ && \qquad {}\lor
   A(\ell_{g1:},\ell_{g2:}|ii|out)~)
\\&& {} \land [in|(\ell_{g1}|\ell_{g1:}),(\ell_{g2}|\ell_{g2:})|out]
}


\subsubsection{Nondeterministic Choice}

\RLEQNS{
   P + Q
   &\defs&
   \W(\quad {}\phlor A(in|ii|\ell_{g1})
\\ && \qquad {} \lor
                     A(in|ii|\ell_{g2})
\\ && \qquad {} \lor
   P[g_{1:},\ell_{g1}/g,in] \lor Q[g_{2:},\ell_{g2}/g,in]~)
\\&& {} \land [in|\ell_{g1}|\ell_{g2}|out]
}

\subsubsection{Nondeterministic Loop}


\RLEQNS{
   P^*
   &\defs&
   \W(\quad  \phlor A(in|ii|out)
\\ && \qquad {}\lor A(in|ii|\ell_g)
\\ && \qquad {}\lor P[g_{:},\ell_g,in/g,in,out]~)
\\&& {} \land [in|\ell_g|out]
}

\subsubsection{Conditional Choice}

\RLEQNS{
   P \dcond c Q
   &\defs&
   \W(\quad {}\phlor c \land A(in|ii|\ell_{g1})
\\ && \qquad {} \lor
                     \lnot c \land A(in|ii|\ell_{g2})
\\ && \qquad {} \lor
   P[g_{1:},\ell_{g1}/g,in] \lor Q[g_{2:},\ell_{g2}/g,in]~)
\\&& {} \land [in|\ell_{g1}|\ell_{g2}|out]
}

\subsubsection{Conditional Loop}


\RLEQNS{
   c \ddo P
   &\defs&
   \W(\quad  \phlor \lnot c \land A(in|ii|out)
\\ && \qquad {}\lor c \land A(in|ii|\ell_g)
\\ && \qquad {}\lor P[g_{:},\ell_g,in/g,in,out]~)
\\&& {} \land [in|\ell_g|out]
}

\newpage
\subsection{Semantic Calculations}

All calculation results have the form
\[ res = I \land (\Skip \lor \bigvee A(\dots)). \]
For ease of reading,
we display the invariant $I$ on the first line,
followed by the list of $A(\dots)$ disjuncts, perhaps several on a line,
as follows
\RLEQNS{
   res &=& I
\\ && A(\dots)_1 \quad A(\dots)_2 \dots
}
We omit parentheses or logical operators.
In general we try to put all the single atomic steps omn the first line,
with all the mumblings on lower lines.

\subsubsection{Atomic Actions}
\RLEQNS{
   c \pgrd a &=& [in|out]
\\ && A(in|c \land a|out)
\\
\\ ii &=& [in|out]
\\ && A(in|ii|out)
}

\subsubsection{Sequential Composition}
\RLEQNS{
   a \cseq b
   &=& [in|\ell_g|out]
\\ && A(in|a|\ell_g)\quad  A(\ell_g|b|out)
\\ && A(in|a\seq b|out)
}

\subsubsection{Non-deterministic Choice}
\RLEQNS{
   a + b
   &=& [in|\ell_{g1}|\ell_{g2}|out]
\\ &&  A(in|ii|\ell_{g1}) \quad A(in|ii|\ell_{g2})
       \quad
       A(\ell_{g1}|a|out) \quad A(\ell_{g2}|b|out)
\\&& A(in|a|out) \quad A(in|b|out)
}

\subsubsection{Parallel Composition}

Here $\#n$ denotes mumblings of length $n$.
\RLEQNS{
   a \parallel b
   &=& [in\mid([\ell_{g1}|\ell_{g1:}],[\ell_{g2}|\ell_{g2:}])\mid out]
\\ &&  A(in|ii|\ell_{g1},\ell_{g2})
       \quad
       A(\ell_{g1:},\ell_{g2:}|ii|out)
       \quad
       A(\ell_{g1}|a|\ell_{g1:})
       \quad
       A(\ell_{g2}|b|\ell_{g2:}) &
\\ && A(in|a|\ell_{g1:},\ell_{g2})
      \quad
      A(\ell_{g1},\ell_{g2}|b;a|\ell_{g1:},\ell_{g2:})
      \quad
      A(in|b|\ell_{g2:},\ell_{g1}) & \#2
\\ && A(\ell_{g1},\ell_{g2}|a ; b|\ell_{g1:},\ell_{g2:})
      \quad
      A(\ell_{g2:},\ell_{g1}|a|out)
      \quad
      A(\ell_{g1:},\ell_{g2}|b|out) & \#2
\\ && A(in|b;a|\ell_{g1:},\ell_{g2:})
      \quad
      A(in|a;b|\ell_{g1:},\ell_{g2:}) & \#3
\\ && A(\ell_{g1},\ell_{g2}|b;a|out)
      \quad
      A(\ell_{g1},\ell_{g2}|a;b|out) & \#3
\\ && A(in|b;a|out)
      \quad
      A(in|a;b|out) & \#4
}
