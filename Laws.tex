\section{Laws}\label{sec:laws}

\subsection{Theory Internals}\label{ssec:internals}

We have a problem in that actions defined using $A(\dots)$
are not closed under standard UTP sequential composition (\eref{UTP-seq-def}).
We need a more general form,
where the labels removed are not necessarily
exactly those that had to be present to enable the action.
We call this eXtended atomic action $X$ and it is defined as follows:
\RLEQNS{
   X(E|a|R|A)
   &\defs&
   ls(E) \land s' \in \sem a s \land ls' = (ls \setminus R) \cup A
   & \elabel{X-def}
}
We can then re-define $A$ in terms of $X$:
\RLEQNS{
   A(E|a|N)
   &=&
   X(E|a|E|N)
   & \elabel{A-alt-def}
}
The key law is one regarding sequentially composing $X$s:
\RLEQNS{
   \lefteqn{X(E_1|a|R_1|A_1) ; X(E_2|b|R_2|A_2)} &&& \elabel{X-then-X}
\\ &=& (E_2\setminus A_1) \cap R_1 = \emptyset
\\ &\land&
   X(E_1 \cup (E_2\setminus A_1)
       |a\seq b
       |R_1 \cup R_2
       |(A_1 \setminus R_2) \cup  A_2)
}
The condition $(E_2\setminus A_1) \cap R_1 = \emptyset$
characterises all those cases were the second $X$ is enabled
immediately after the first $X$ terminates
(i.e., without any outside interference).

\subsection{Equality}\label{ssec:equality}

\subsubsection{Hiding Label-Sets}\label{sssec:HL}

For now, we define equality and refinement as follows,
where we have to ``Hide Labels'':
\RLEQNS{
   \HL(P) &\defs& \exists ls,ls' @ P & \elabel{HL-def}
\\ P=Q &\defs& [ \HL(P) \equiv \HL(Q) ] & \elabel{HL-EQ-def}
\\ P \refinedby Q &\defs& [ \HL(Q) \implies \HL(P) ] & \elabel{HL-RFBY-def}
}
As $ls$ and $ls'$ are no longer free in the result of applying $\HL$,
we can consider it as removing those two variables from the alphabet.
The following law is an immediate consequence of the definition:
\RLEQNS{
   \HL(A \lor B) &=& \HL(A) \lor \HL(B) & \elabel{HL-or-distr}
}

Provided $E$ is ground, then:
\RLEQNS{
   \HL(X(E|a|R|A)) &=& a
   & \elabel{HL-X-red}
\\ \HL(A(E|a|N)) &=& a
   & \elabel{HL-A-red}
}
Provided $E[G,I,O/g,in,out]$ is ground, then:
\RLEQNS{
   \HL(X(E|a|R|A)[G,I,O/g,in,out]) &=& a
   & \elabel{HL-X-sub-red}
\\ \HL(A(E|a|N)[G,I,O/g,in,out]) &=& a
   & \elabel{HL-A-sub-red}
}
As all the language semantic definitions boil down to a large
disjunction of $X$ or $A$ predicates and substitutions satisfying
the two groundedness side-conditions above,
we see that the effect of $\HL$ is not just to remove
all free occurrences of $ls$ and $ls'$,
but also has the effect of removing all uses of $g$, $in$ and $out$.
All that remains are the underlying actions on program state.

Considering invariants in the mix, assuming $E$ is ground
and that $E \textbf{ lsat } I$:
\RLEQNS{
   \HL(I \land \Skip) &=&  ii & \elabel{HL-I-and-skip}
\\ \HL(I \land X(E|a|R|A) \land S)
   &=& a \land S
   & \elabel{HL-I-and-X}
\\ \HL(I \land A(E|a|N))
   &=& a
   & \elabel{HL-I-and-A}
}
Here $S$ is a predicate over ground label-set expressions.
We intend to use this law on $X$-components calculated in the
context of invariant $I$, so we always expect $E$ to satisfy $I$.

Assume that $P$ has a normal form as follows,
where $A(a_i)$ is shorthand for $A(E_i|a_i|N_i)$:
\[
   I \land \left( \Skip \lor \bigvee A(a_i) \right)
\]
then
\RLEQNS{
  \HL(P) &=& ii \lor \bigvee a_i
  & \elabel{HL-nf}
}
All the above results generalise to the case were we have a conjunction
of invariants:
\RLEQNS{
   \HL(I \land J \land \Skip) &=& ii
\\ \HL(I \land J \land A(a)) &=& a
}


The key to proving the language laws is the following law of $\HL$
that captures its independence under any \emph{valid} substitution.
\RLEQNS{
   \HL(P[G_1,I_1,O_1/g,in,out])
   &=&
   \HL(P[G_2,I_2,O_2/g,in,out])
   & \elabel{HL-subs-indep}
}
Such substitutions are \emph{valid} provided they satisfy the invariant
$(I_i | labs(G_i) | O_i)$ for $i=1,2$.
This excludes pathological substitutions that mix up input, output
and internal labels, which would alter the resulting normal form.

\subsubsection{Language Laws}\label{ssec:lang-laws}
\RLEQNS{
   \cskip \cseq P &=& P & \elab{$\cseq$-l-unit}{;;-l-unit}
\\ P \cseq \cskip &=& P & \elab{$\cseq$-Q-unit}{;;-r-unit}
\\ P \cseq ( Q \cseq R) &=& ( P \cseq Q ) \cseq R
   & \elab{$\cseq$-assoc}{;;-assoc}
\\ P \parallel Q &=& Q \parallel P & \elab{$\parallel$-comm}{||-comm}
\\ P \parallel ( Q \parallel R) &=& ( P \parallel Q ) \parallel R
   & \elab{$\parallel$-assoc}{||-assoc}
\\ P + Q &=& Q+P
\\ P + ( Q + R) &=& ( P + Q ) + R
\\ P + Q &\refinedby& P
\\ P \sqsubseteq Q &\equiv& (P + Q) = Q
\\ P^* &=& \cskip + P \cseq P^*
\\ P \dcond{true} Q &=& P & \elab{$\dcond{true}$}{lcond-true}
\\ P \dcond{false} Q &=& Q & \elab{$\dcond{false}$}{lcond-false}
\\ (P_1 \dcond c P_2) \cseq P_3 &=& (P_1 \cseq P_3) \dcond c (P_2 \cseq P_3)
\\ c \ddo P &=& (P \cseq c \ddo P) \dcond c \cskip
   & \elab{$\ddo$-unroll}{wdo-unroll}
\\ P_1 \cseq (P_2 \parallel P_3) &\sqsubseteq& (P_1 \cseq P_2) \parallel P_3
\\ P_1 \cseq P_2 &\sqsubseteq& P_1 \parallel P_2
\\ P_1 \dcond{c_1 \land c_2} P_2
   &\sqsubseteq&
   (P_1 \dcond{c_2} P_2) \dcond{c_1} P_2
}

If we have assignments $x:=e$, then the following apply:
\RLEQNS{
   \cskip &=& i:=i & \mbox{atomic assignment}
\\ \cskip &\sqsubseteq& x:=x &\mbox{non-atomic assignment}
\\ x:=e_2[e_1/x] &\sqsubseteq& x:=e_1 \cseq x:=e_2 & e_i \mbox{ deterministic}
\\ x_1:=e_1 \parallel x_2:=e_2
   &=&
   (x_1:=e_1 \cseq x_2:=e_2)
\\ && {} + (x_2:=e_2 \cseq x_1:=e_1)
}
The latter holding for atomic assignment.

\subsection{Finding Bisimulations}


Idea: define the desired bisimulations in such a way that
we can manipulate them with the same kind of substitutions
as found in the semantics.

\subsubsection{\protect{$a \parallel b = b \parallel a$}}

Consider a simple example: prove that $a \parallel b = b \parallel a$,

\RLEQNS{
  && a \parallel b
\EQ{defn of $\parallel$ }
\\&&      in \arr{ii} \setof{\ell_{g1},\ell_{g2}}
     \lor \setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out
\\ &\lor&
   a[g_{1::},\ell_{g1},\ell_{g1:}/g,in,out]
   \lor b[g_{2::},\ell_{g2},\ell_{g2:}/g,in,out]
\EQ{defn of $a$ and $b$}
\\&&      in \arr{ii} \setof{\ell_{g1},\ell_{g2}}
     \lor \setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out
\\ &\lor&
   (in \arr a out)[g_{1::},\ell_{g1},\ell_{g1:}/g,in,out]
   \lor (in \arr b out)[g_{2::},\ell_{g2},\ell_{g2:}/g,in,out]
\EQ{substitutions, as per above}
\\&& in \arr{ii} \setof{\ell_{g1},\ell_{g2}}
     \lor
     \ell_{g1} \arr a \ell_{g1:}
     \lor
     \ell_{g2} \arr b \ell_{g2:}
     \lor
     \setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out
\\
\\&& b \parallel a
\EQ{Above calculations with $a$ and $b$ swapped}
\\&& in \arr{ii} \setof{\ell_{g1},\ell_{g2}}
     \lor
     \ell_{g1} \arr b \ell_{g1:}
     \lor
     \ell_{g2} \arr a \ell_{g2:}
     \lor
     \setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out
}

If we define%
\footnote{If is a label is not mentioned, it maps to itself}
the following bijection on labels:
\[
  \ell_{g1} \mapsto \ell{g2}
, \ell_{g1:} \mapsto \ell{g2:}
, \ell_{g2} \mapsto \ell{g1}
, \ell_{g2:} \mapsto \ell{g1:}
\]
we can show that the two sides are isomorphic modulo that bijection.
Interestingly, this isomorphism works if we define the following
generator bijection $g1 \rightleftharpoons g2$.

\subsubsection{\protect{$(a \cseq b)\parallel c = c \parallel (a \cseq b)$}}

Now, a bit more ambitious---consider
\[ (a \cseq b)\parallel c
    = c \parallel (a \cseq b)
\]

LHS:
\RLEQNS{
   && (a \cseq b)\parallel c
\EQ{defn $\parallel$}
\\&& in \arr{ii} \setof{\ell_{g1},\ell_{g2}}
      \lor \setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out \lor {}
\\ &&
   (a \cseq b)[g_{1::},\ell_{g1},\ell_{g1:}/g,in,out]
   \lor c[g_{2::},\ell_{g2},\ell_{g2:}/g,in,out]
\EQ{defn $\cseq$}
\\&& in \arr{ii} \setof{\ell_{g1},\ell_{g2}}
      \lor \setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out \lor {}
\\ &&
   (a[g_{:1},\ell_g/g,out] \lor b[g_{:2},\ell_g/g,in])[g_{1::},\ell_{g1},\ell_{g1:}/g,in,out]
\\&& {}\lor c[g_{2::},\ell_{g2},\ell_{g2:}/g,in,out]
\EQ{atomic substitution}
\\&& in \arr{ii} \setof{\ell_{g1},\ell_{g2}}
      \lor \setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out \lor {}
\\ &&
   (in \arr a \ell_g \lor \ell_g \arr b out)[g_{1::},\ell_{g1},\ell_{g1:}/g,in,out]
\\&& {}\lor \ell_{g2} \arr c\ell_{g2:}
\EQ{substitution}
\\&& in \arr{ii} \setof{\ell_{g1},\ell_{g2}}
      \lor \setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out \lor {}
\\ &&
   \ell_{g1} \arr a \ell_{g1::}
   \lor \ell_{g1::} \arr b \ell_{g1:}
   \lor \ell_{g2} \arr c\ell_{g2:}
}

RHS:
\RLEQNS{
  && c \parallel (a \cseq b)
\EQ{defn $\parallel$}
\\&& in \arr{ii} \setof{\ell_{g1},\ell_{g2}}
      \lor \setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out \lor {}
\\ &&
   c[g_{1::},\ell_{g1},\ell_{g1:}/g,in,out]
   \lor (a \cseq b)[g_{2::},\ell_{g2},\ell_{g2:}/g,in,out]
\EQ{defn $\cseq$}
\\&& in \arr{ii} \setof{\ell_{g1},\ell_{g2}}
      \lor \setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out \lor {}
\\ &&
   c[g_{1::},\ell_{g1},\ell_{g1:}/g,in,out] \lor {}
\\&& (a[g_{:1},\ell_g/g,out] \lor b[g_{:2},\ell_g/g,in])[g_{2::},\ell_{g2},\ell_{g2:}/g,in,out]
\EQ{atomic substitution}
\\&& in \arr{ii} \setof{\ell_{g1},\ell_{g2}}
      \lor \setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out \lor {}
\\ &&
   \ell_{g1} \arr c \ell_{g1:} \lor {}
\\&& (in \arr a \ell_g \lor \ell_g \arr b out)[g_{2::},\ell_{g2},\ell_{g2:}/g,in,out]
\EQ{substitution}
\\&& in \arr{ii} \setof{\ell_{g1},\ell_{g2}}
      \lor \setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out \lor {}
\\ &&
   \ell_{g1} \arr c \ell_{g1:}
   \lor \ell_{g2} \arr a \ell_{g2::}
   \lor \ell_{g2::} \arr b \ell_{g2:}
}

Reprise LHS:
\[
in \arr{ii} \setof{\ell_{g1},\ell_{g2}} \lor
\setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out \lor
\ell_{g1} \arr a \ell_{g1::} \lor
\ell_{g1::} \arr b \ell_{g1:} \lor
\ell_{g2} \arr c\ell_{g2:}
\]
Reprise RHS:
\[
in \arr{ii} \setof{\ell_{g1},\ell_{g2}} \lor
\setof{\ell_{g1:},\ell_{g2:}} \arr{ii} out \lor
\ell_{g1} \arr c \ell_{g1:} \lor
\ell_{g2} \arr a \ell_{g2::} \lor
\ell_{g2::} \arr b \ell_{g2:}
\]
Reorder LHS:
\[
in \arr{ii} \setof{\ell_{g2},\ell_{g1}} \lor
\setof{\ell_{g2:},\ell_{g1:}} \arr{ii} out \lor
\ell_{g2} \arr c\ell_{g2:} \lor
\ell_{g1} \arr a \ell_{g1::} \lor
\ell_{g1::} \arr b \ell_{g1:}
\]
We immediately see the following bijection: $g1 \leftrightharpoons g2$.

\subsubsection{\protect{$(a \cseq b) \cseq c   = a \cseq (b \cseq c)$}}

Now we look at the following:
\[
  (a \cseq b) \cseq c   = a \cseq (b \cseq c)
\]

LHS:
\RLEQNS{
  && (a \cseq b) \cseq c
\EQ{defn $\cseq$}
\\&& (a \cseq b)[g_{:1},\ell_g/g,out] \lor c[g_{:2},\ell_g/g,in]
\EQ{defn $\cseq$}
\\&& (a[g_{:1},\ell_g/g,out] \lor b[g_{:2},\ell_g/g,in])[g_{:1},\ell_g/g,out]
     \lor c[g_{:2},\ell_g/g,in]
\EQ{atomic substitution}
\\&& (in \arr a out \lor \ell_g \arr b out)[g_{:1},\ell_g/g,out]
     \lor \ell_g \arr c out
\EQ{substitution}
\\&& in \arr a \ell_{g:1} \lor \ell_{g:1} \arr b \ell_g \lor \ell_g \arr c out
}

% C[g_{:1},\ell_g/g,out] \lor D[g_{:2},\ell_g/g,in]
RHS:
\RLEQNS{
  && a \cseq (b \cseq c)
\EQ{defn $\cseq$}
\\&& a[g_{:1},\ell_g/g,out] \lor (b \cseq c)[g_{:2},\ell_g/g,in]
\EQ{defn $\cseq$}
\\&& a[g_{:1},\ell_g/g,out] \lor
  (b[g_{:1},\ell_g/g,out] \lor c[g_{:2},\ell_g/g,in])[g_{:2},\ell_g/g,in]
\EQ{atomic substitution}
\\&& in \arr a \ell_g \lor
  (in \arr b \ell_g \lor \ell_g \arr c out)[g_{:2},\ell_g/g,in]
\EQ{substitution}
\\&& in \arr a \ell_g \lor \ell_g \arr b \ell_{g:2} \lor \ell_{g:2} \arr c out
}

We see the following bijection:
$\ell_{g:1} \leftrightharpoons \ell_{g},
 \ell_{g}   \leftrightharpoons \ell_{g:2}
$

\subsubsection{Bijective Substitutions}

Idea: aren't all our substitutions actually bijections?
\begin{eqnarray*}
   \cseq
   &&
   [g_{:1},\ell_g/g,out]
   [g_{:2},\ell_g/g,in]
\\ +
   &&
   [g_{1:},\ell_{g1}/g,in]
   [g_{2:},\ell_{g2}/g,in]
\\ \parallel
   &&
   [g_{1::},\ell_{g1},\ell_{g1:}/g,in,out]
   [g_{2::},\ell_{g2},\ell_{g2:}/g,in,out]
\\ {}^*
   &&
   [g_{:},\ell_g,in/g,in,out]
\end{eqnarray*}
Under reasonable assumptions about the structure and use of everything,
at least.
